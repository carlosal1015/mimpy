

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mimpy.mfd.mfd &mdash; mimpy 0.1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="mimpy 0.1.0 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../../index.html" class="fa fa-home"> mimpy</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../singlephasesection.html">Single-Phase</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../singlephase.html">Single-Phase Derivation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../singlephaseexample.html">Single-Phase Example Walk Through</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../codeoverview.html">Code Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examplegallery.html">Model Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../twophaseexample1.html">Buckley-Leverett</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../twophaseexample2.html">SPE 10 Layer 85</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#types-of-contributions">Types of Contributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#get-started">Get Started!</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#pull-request-guidelines">Pull Request Guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#tips">Tips</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">Mimpy Modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../meshmodule.html">mesh</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../mfdmodule.html">mfd</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modelmodule.html">models</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">mimpy</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>mimpy.mfd.mfd</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for mimpy.mfd.mfd</h1><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">array</span>
<span class="kn">import</span> <span class="nn">mimpy.mfd.mfd_cython</span> <span class="kn">as</span> <span class="nn">mfd_cython</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">sparse</span><span class="p">,</span> <span class="n">diag</span>
<span class="kn">import</span> <span class="nn">scipy.sparse.linalg.dsolve</span> <span class="kn">as</span> <span class="nn">dsolve</span>
<span class="kn">import</span> <span class="nn">scipy.sparse.linalg</span> <span class="kn">as</span> <span class="nn">linalg</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">zip</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">petsc4py</span>
    <span class="n">petsc4py</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns the sign of float x.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">1.</span>

<div class="viewcode-block" id="MFD"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD">[docs]</a><span class="k">class</span> <span class="nc">MFD</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; The MFD class provides functionality for</span>
<span class="sd">    constructing mimetic discretization matrices</span>
<span class="sd">    for sovling elliptic PDE. An instance of MFD</span>
<span class="sd">    constructs the matrices based on the information</span>
<span class="sd">    it finds in an instance of the Mesh class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flux_dof</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pressure_dof</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_dof</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_flux_dof</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neumann_needs_updating</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_m_e</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m_elist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_diag_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">print_progress</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compute_diagonality</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># List indicating orthogonality of cells.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diagonality_index_list</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m_e_construction_method</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># Data needed for updating matrix Mx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_data_for_update</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_e_locations</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># dict: {face_index: Dirichlet value, ... }</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirichlet_boundary_values</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># dict: {face_index: Neumann value, ... }</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neumann_boundary_values</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># list: [F1, F2, F3, ....]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_forcing_function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c"># Dict from cell to a list of faces</span>
        <span class="c"># in the cell that are also neumann faces.</span>
        <span class="c"># Used for incroporating the boundary</span>
        <span class="c"># conditions when building m and div_t.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_faces_neumann</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">non_ortho_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_ortho</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="MFD.set_mesh"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.set_mesh">[docs]</a>    <span class="k">def</span> <span class="nf">set_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Links the MFD object to an instance of a Mesh class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_forcing_function</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">(),</span>
                                          <span class="n">refcheck</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_internal_boundaries</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="MFD.get_flux_dof"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.get_flux_dof">[docs]</a>    <span class="k">def</span> <span class="nf">get_flux_dof</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns number of flux</span>
<span class="sd">        degrees of freedom.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux_dof</span>
</div>
<div class="viewcode-block" id="MFD.get_pressure_dof"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.get_pressure_dof">[docs]</a>    <span class="k">def</span> <span class="nf">get_pressure_dof</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns number of pressure</span>
<span class="sd">        degrees of freedom.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_dof</span>
</div>
<div class="viewcode-block" id="MFD.get_total_dof"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.get_total_dof">[docs]</a>    <span class="k">def</span> <span class="nf">get_total_dof</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns number of total</span>
<span class="sd">        degrees of freedom.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_dof</span>
</div>
<div class="viewcode-block" id="MFD.set_compute_diagonality"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.set_compute_diagonality">[docs]</a>    <span class="k">def</span> <span class="nf">set_compute_diagonality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setting</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; During matrix M_x construction, compute how</span>
<span class="sd">        diagonal the local stiffness matrices</span>
<span class="sd">        m_e. The equation is:</span>

<span class="sd">        ||M_E - diag(diag(M_E)||_2/||M_E||_2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_diagonality</span> <span class="o">=</span> <span class="n">setting</span>
</div>
<div class="viewcode-block" id="MFD.get_diagonality"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.get_diagonality">[docs]</a>    <span class="k">def</span> <span class="nf">get_diagonality</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a list of cell diagonality indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagonality_index_list</span>
</div>
<div class="viewcode-block" id="MFD.set_m_e_construction_method"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.set_m_e_construction_method">[docs]</a>    <span class="k">def</span> <span class="nf">set_m_e_construction_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set construction method for the local matrices</span>
<span class="sd">        m_e. Method indices correspond to:</span>

<span class="sd">        0 =&gt; U = R^TR(R^TN)^-1</span>

<span class="sd">        1 =&gt; U = trace(k^(-1))|E|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_e_construction_method</span> <span class="o">=</span> <span class="n">method_index</span>
</div>
<div class="viewcode-block" id="MFD.renumber_for_neumann"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.renumber_for_neumann">[docs]</a>    <span class="k">def</span> <span class="nf">renumber_for_neumann</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Renumbers the neumann faces</span>
<span class="sd">        in order to remove them as degrees</span>
<span class="sd">        of freedom in final matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_faces</span><span class="p">(),</span> <span class="mi">1</span><span class="p">),</span>
                                     <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">face_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_faces</span><span class="p">()):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_neumann_face</span><span class="p">(</span><span class="n">face_index</span><span class="p">):</span>
                <span class="n">index_offset</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">face_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">face_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">face_index</span><span class="o">-</span><span class="n">index_offset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flux_dof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_faces</span><span class="p">()</span><span class="o">-</span><span class="n">index_offset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">neumann_needs_updating</span> <span class="o">=</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="MFD.build_div_full"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_div_full">[docs]</a>    <span class="k">def</span> <span class="nf">build_div_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Build the div and -div^T matrices and returns</span>
<span class="sd">        arrays for constructing a coo sparse matrix</span>
<span class="sd">        representation. The lists returned are:</span>

<span class="sd">        [[div_data, div_row, div_col],</span>
<span class="sd">        [div_t_data, div_t_row, div_t_col]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">div_data</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;f&#39;</span><span class="p">)</span>
        <span class="n">div_row</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">div_col</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>

        <span class="n">div_t_data</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;f&#39;</span><span class="p">)</span>
        <span class="n">div_t_row</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">div_t_col</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">current_cell_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">()):</span>
            <span class="n">current_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">current_cell_index</span><span class="p">)</span>
            <span class="n">current_cell_orientations</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_normal_orientation</span><span class="p">(</span><span class="n">current_cell_index</span><span class="p">)</span>

            <span class="n">neumann_faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cell_faces_neumann</span><span class="p">(</span><span class="n">current_cell_index</span><span class="p">)</span>

            <span class="k">for</span> <span class="p">[</span><span class="n">face_index</span><span class="p">,</span> <span class="n">face_orientation</span><span class="p">]</span> <span class="ow">in</span> \
                    <span class="nb">zip</span><span class="p">(</span><span class="n">current_cell</span><span class="p">,</span> <span class="n">current_cell_orientations</span><span class="p">):</span>

                <span class="n">new_entry</span> <span class="o">=</span> <span class="n">face_orientation</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_area</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>

                <span class="n">div_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_entry</span><span class="p">)</span>
                <span class="n">div_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_cell_index</span><span class="o">+</span>
                               <span class="n">shift</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_faces</span><span class="p">())</span>
                <span class="n">div_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">face_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">neumann_faces</span><span class="p">:</span>
                    <span class="n">div_t_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">new_entry</span><span class="p">)</span>
                    <span class="n">div_t_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
                    <span class="n">div_t_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_cell_index</span><span class="o">+</span>
                                     <span class="n">shift</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_faces</span><span class="p">())</span>

        <span class="k">return</span> <span class="p">[[</span><span class="n">div_data</span><span class="p">,</span> <span class="n">div_row</span><span class="p">,</span> <span class="n">div_col</span><span class="p">],</span>
                <span class="p">[</span><span class="n">div_t_data</span><span class="p">,</span> <span class="n">div_t_row</span><span class="p">,</span> <span class="n">div_t_col</span><span class="p">]]</span>
</div>
<div class="viewcode-block" id="MFD.build_div"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_div">[docs]</a>    <span class="k">def</span> <span class="nf">build_div</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Build the div and -div^T matrices and returns</span>
<span class="sd">        arrays for constructing a coo sparse matrix</span>
<span class="sd">        representation. The lists returned are:</span>

<span class="sd">        [[div_data, div_row, div_col],</span>
<span class="sd">        [div_t_data, div_t_row, div_t_col]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">div_data</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">div_row</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">div_col</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>

        <span class="n">div_t_data</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">div_t_row</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">div_t_col</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neumann_needs_updating</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renumber_for_neumann</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">current_cell_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">()):</span>
            <span class="n">current_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">current_cell_index</span><span class="p">)</span>
            <span class="n">current_cell_orientations</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_normal_orientation</span><span class="p">(</span><span class="n">current_cell_index</span><span class="p">)</span>

            <span class="n">neumann_faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cell_faces_neumann</span><span class="p">(</span><span class="n">current_cell_index</span><span class="p">)</span>

            <span class="k">for</span> <span class="p">[</span><span class="n">face_index</span><span class="p">,</span> <span class="n">face_orientation</span><span class="p">]</span> <span class="ow">in</span> \
                    <span class="nb">zip</span><span class="p">(</span><span class="n">current_cell</span><span class="p">,</span> <span class="n">current_cell_orientations</span><span class="p">):</span>

                <span class="n">new_entry</span> <span class="o">=</span> <span class="n">face_orientation</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_area</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">face_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">neumann_faces</span><span class="p">:</span>
                    <span class="n">div_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_entry</span><span class="p">)</span>
                    <span class="n">div_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_cell_index</span><span class="o">+</span>
                                   <span class="n">shift</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_dof</span><span class="p">)</span>
                    <span class="n">div_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">face_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

                    <span class="n">div_t_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">new_entry</span><span class="p">)</span>
                    <span class="n">div_t_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">face_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="n">div_t_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_cell_index</span><span class="o">+</span>
                                     <span class="n">shift</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_dof</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[[</span><span class="n">div_data</span><span class="p">,</span> <span class="n">div_row</span><span class="p">,</span> <span class="n">div_col</span><span class="p">],</span>
                <span class="p">[</span><span class="n">div_t_data</span><span class="p">,</span> <span class="n">div_t_row</span><span class="p">,</span> <span class="n">div_t_col</span><span class="p">]]</span>
</div>
<div class="viewcode-block" id="MFD.build_r_e"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_r_e">[docs]</a>    <span class="k">def</span> <span class="nf">build_r_e</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Build matrix R_E for construction of</span>
<span class="sd">        local stiffness matrix M_E.</span>
<span class="sd">        The function defaults to using the</span>
<span class="sd">        real centroids of the cells and faces</span>
<span class="sd">        unless otherwise specified by functions</span>
<span class="sd">        is_using_face_shifted_centroid and</span>
<span class="sd">        is_using_cell_shifted_centroid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cell_faces</span><span class="p">(</span><span class="n">cell_index</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">))</span>

        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">is_using_cell_shifted_centroid</span><span class="p">():</span>
            <span class="n">cell_centroid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_shifted_centroid</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cell_centroid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_real_centroid</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">face_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_index</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">is_using_face_shifted_centroid</span><span class="p">():</span>
                    <span class="n">face_centroid</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_shifted_centroid</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">face_centroid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_real_centroid</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>

                <span class="n">r_e</span><span class="p">[</span><span class="n">counter</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_area</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
                <span class="n">r_e</span><span class="p">[</span><span class="n">counter</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="n">face_centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">cell_centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="n">r_e</span><span class="p">[</span><span class="n">counter</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_area</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
                <span class="n">r_e</span><span class="p">[</span><span class="n">counter</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="n">face_centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cell_centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                <span class="n">r_e</span><span class="p">[</span><span class="n">counter</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_area</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
                <span class="n">r_e</span><span class="p">[</span><span class="n">counter</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="n">face_centroid</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">cell_centroid</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">r_e</span>
</div>
<div class="viewcode-block" id="MFD.build_n_e"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_n_e">[docs]</a>    <span class="k">def</span> <span class="nf">build_n_e</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_index</span><span class="p">,</span> <span class="n">k_unity</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Build matrix N_E using the standard</span>
<span class="sd">        definition for the mimetic method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">number_of_faces</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_index</span><span class="p">))</span>
        <span class="n">n_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_faces</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">))</span>

        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">face_face_orientation</span> <span class="o">=</span> \
            <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_index</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_normal_orientation</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">k_unity</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">[</span><span class="n">face_index</span><span class="p">,</span> <span class="n">face_orientation</span><span class="p">]</span> <span class="ow">in</span> <span class="n">face_face_orientation</span><span class="p">:</span>
                <span class="n">n_e</span><span class="p">[</span><span class="n">counter</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_normal</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
                <span class="n">n_e</span><span class="p">[</span><span class="n">counter</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="n">face_orientation</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">[</span><span class="n">face_index</span><span class="p">,</span> <span class="n">face_orientation</span><span class="p">]</span> <span class="ow">in</span> <span class="n">face_face_orientation</span><span class="p">:</span>
                <span class="n">n_e</span><span class="p">[</span><span class="n">counter</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_k</span><span class="p">(</span><span class="n">cell_index</span><span class="p">),</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_normal</span><span class="p">(</span><span class="n">face_index</span><span class="p">))</span>
                <span class="n">n_e</span><span class="p">[</span><span class="n">counter</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="n">face_orientation</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">n_e</span>
</div>
<div class="viewcode-block" id="MFD.build_c_e"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_c_e">[docs]</a>    <span class="k">def</span> <span class="nf">build_c_e</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Construct matrix C_E. The matrix</span>
<span class="sd">        must satisfy N_E^T C_E = 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>

        <span class="n">c_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">v</span><span class="p">)[:,</span> <span class="mi">3</span><span class="p">:]</span>

        <span class="k">return</span> <span class="n">c_e</span>
</div>
<div class="viewcode-block" id="MFD.build_d_e"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_d_e">[docs]</a>    <span class="k">def</span> <span class="nf">build_d_e</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Construct matrix D_E. The matrix</span>
<span class="sd">        must satisfy R_E^T D_E = 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">c_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">v</span><span class="p">)[:,</span> <span class="mi">3</span><span class="p">:]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">c_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">v</span><span class="p">)[:,</span> <span class="mi">2</span><span class="p">:]</span>

        <span class="k">return</span> <span class="n">c_e</span>
</div>
<div class="viewcode-block" id="MFD.build_w_e"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_w_e">[docs]</a>    <span class="k">def</span> <span class="nf">build_w_e</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Construct matrix W_E from Brezzi et al.</span>
<span class="sd">        paper.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_r_e</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
        <span class="n">n_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_n_e</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>

        <span class="n">d_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_d_e</span><span class="p">(</span><span class="n">r_e</span><span class="p">)</span>
        <span class="n">current_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_k</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
        <span class="n">k_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">current_k</span><span class="p">)</span>

        <span class="n">w_e</span> <span class="o">=</span> <span class="n">n_e</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">n_e</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r_e</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">n_e</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

        <span class="n">w_e</span> <span class="o">+=</span> <span class="n">d_e</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">d_e</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">w_e</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">current_k</span><span class="p">)</span>
        <span class="n">w_e</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_volume</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">w_e</span>
</div>
<div class="viewcode-block" id="MFD.build_m_e"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_m_e">[docs]</a>    <span class="k">def</span> <span class="nf">build_m_e</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_index</span><span class="p">,</span> <span class="n">k_unity</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Construct the local stiffness matrix M_E.</span>
<span class="sd">        The construction is based on the relation:</span>
<span class="sd">        M_E = R_E (R_E^T N_E)^-1 R_E^T + C_E U C_E^T</span>
<span class="sd">        Matrix U is a parameter that can be chosen</span>
<span class="sd">        during construction. The options for setting</span>
<span class="sd">        parameter U are set using function</span>
<span class="sd">        set_m_e_construction_method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_r_e</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k_unity</span><span class="p">:</span>
            <span class="n">n_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_n_e</span><span class="p">(</span><span class="n">cell_index</span><span class="p">,</span> <span class="n">k_unity</span><span class="p">)</span>
            <span class="n">current_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_n_e</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
            <span class="n">current_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_k</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>

        <span class="n">is_ortho</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">c_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_c_e</span><span class="p">(</span><span class="n">n_e</span><span class="p">)</span>

        <span class="n">m_0</span> <span class="o">=</span>  <span class="n">r_e</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r_e</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">n_e</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r_e</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_e_construction_method</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r_e</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">n_e</span><span class="p">))</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r_e</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">r_e</span><span class="p">),</span> <span class="n">u</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">m_e</span> <span class="o">=</span> <span class="n">m_0</span>
            <span class="n">m_e</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c_e</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">c_e</span><span class="p">)))</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_e_construction_method</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_volume</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">current_k</span><span class="p">)</span>
            <span class="n">m_e</span> <span class="o">=</span> <span class="n">m_0</span>
            <span class="n">m_e</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c_e</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">c_e</span><span class="p">)))</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_e_construction_method</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c">## Based on producing RT0 for triangles</span>
            <span class="c">## from &quot;The Mimetic Finite Difference Method&quot;</span>
            <span class="c">## By Gianmarco Manzini,  Eqn 54.</span>
            <span class="n">k_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">current_k</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">for</span> <span class="n">face_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_index</span><span class="p">):</span>
                <span class="n">x_e_min_x_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_real_centroid</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span><span class="o">-</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_real_centroid</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
                <span class="n">u</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x_e_min_x_E</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">k_inv</span><span class="p">,</span> <span class="n">x_e_min_x_E</span><span class="p">))</span>
            <span class="n">u</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">dim</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">u</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cell_faces</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
            <span class="n">m_e</span> <span class="o">=</span> <span class="n">m_0</span>
            <span class="n">m_e</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c_e</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">c_e</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_e_construction_method</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c">## Based on Mimetic Finite Difference method</span>
            <span class="c">## in JCP 2013.</span>
            <span class="n">lambda_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">r_e</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>
            <span class="n">lambda_c</span> <span class="o">=</span> <span class="n">lambda_c</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r_e</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">lambda_c</span> <span class="o">=</span> <span class="n">r_e</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lambda_c</span><span class="p">)</span>
            <span class="n">lambda_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">lambda_c</span><span class="p">)</span>
            <span class="n">lambda_c</span> <span class="o">*=</span> <span class="o">.</span><span class="mi">5</span>

            <span class="n">m_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cell_faces</span><span class="p">(</span><span class="n">cell_index</span><span class="p">))</span>
            <span class="n">m_e</span> <span class="o">-=</span> <span class="p">(</span><span class="n">n_e</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">n_e</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">n_e</span><span class="p">))))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">n_e</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">m_e</span> <span class="o">=</span> <span class="n">lambda_c</span><span class="o">*</span><span class="p">(</span><span class="n">m_e</span><span class="p">)</span>
            <span class="n">m_e</span> <span class="o">+=</span> <span class="n">m_0</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_e_construction_method</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">m_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_w_e</span><span class="p">(</span><span class="n">cell_index</span><span class="p">))</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_e_construction_method</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">diagonal</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">def</span> <span class="nf">absmaxindex</span><span class="p">(</span><span class="n">vector</span><span class="p">):</span>
                <span class="n">current_max</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vector</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">max_index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vector</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vector</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">&gt;</span><span class="n">current_max</span><span class="p">:</span>
                        <span class="n">max_index</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="n">current_max</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vector</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">max_index</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_index</span><span class="p">))):</span>
                <span class="n">max_index</span> <span class="o">=</span> <span class="n">absmaxindex</span><span class="p">(</span><span class="n">r_e</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
                <span class="n">diagonal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_e</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">max_index</span><span class="p">]</span><span class="o">/</span><span class="n">n_e</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">max_index</span><span class="p">])</span>

            <span class="n">m_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">diagonal</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_e_construction_method</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">m_e</span> <span class="o">=</span>  <span class="n">r_e</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r_e</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">n_e</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r_e</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
            <span class="n">diagonal</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">face_orientation_list</span> <span class="o">=</span> \
                <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_index</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_normal_orientation</span><span class="p">(</span><span class="n">cell_index</span><span class="p">))</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">face_index</span><span class="p">,</span> <span class="n">orientation</span><span class="p">)</span> <span class="ow">in</span> <span class="n">face_orientation_list</span><span class="p">:</span>
                <span class="n">normal</span> <span class="o">=</span> <span class="n">orientation</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_normal</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">normal</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">current_k</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">normal</span><span class="p">))</span>
                <span class="n">entry</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_area</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
                <span class="n">entry</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_real_centroid</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span><span class="o">-</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_real_centroid</span><span class="p">(</span><span class="n">cell_index</span><span class="p">))</span>
                <span class="n">diagonal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

            <span class="n">diagonal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">diagonal</span><span class="p">)</span>
            <span class="n">m_e</span> <span class="o">+=</span> <span class="n">diagonal</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c_e</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c_e</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_m_e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">m_e</span><span class="p">,</span> <span class="n">n_e</span><span class="p">)</span><span class="o">-</span><span class="n">r_e</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.e-6</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;M_E N ne R&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">m_e</span><span class="p">,</span> <span class="n">n_e</span><span class="p">)</span><span class="o">-</span><span class="n">r_e</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_diagonality</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diagonality_index_list</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">m_e</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">m_e</span><span class="p">)))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">m_e</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagonality_index_list</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.e-8</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_ortho</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="n">m_e</span>
</div>
<div class="viewcode-block" id="MFD.build_m_full"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_m_full">[docs]</a>    <span class="k">def</span> <span class="nf">build_m_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_update_info</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">k_unity</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Construct the global matrix M_x. This is</span>
<span class="sd">        done by first constructing local matrices</span>
<span class="sd">        M_E and constructing a coo matrix for</span>
<span class="sd">        the global matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_diagonality</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diagonality_index_list</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">())</span>

        <span class="n">m_data</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;f&#39;</span><span class="p">)</span>
        <span class="n">m_row</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">m_col</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_update_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m_e_locations</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">current_length</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">()):</span>
            <span class="n">m_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_m_e</span><span class="p">(</span><span class="n">cell_index</span><span class="p">,</span> <span class="n">k_unity</span><span class="p">)</span>

            <span class="n">m_e_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">m_e</span><span class="p">)</span>
            <span class="n">neumann_faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cell_faces_neumann</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>

            <span class="n">current_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
            <span class="n">current_orientation</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_normal_orientation</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m_e</span><span class="p">)):</span>
                <span class="n">global_i</span> <span class="o">=</span> <span class="n">current_cell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">global_i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">neumann_faces</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m_e</span><span class="p">)):</span>
                        <span class="n">global_j</span> <span class="o">=</span> <span class="n">current_cell</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m_e</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="n">m_e_norm</span> <span class="o">&gt;</span> <span class="mf">1.e-12</span><span class="p">:</span>
                            <span class="n">current_length</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">m_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m_e</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">*</span>
                                          <span class="n">current_orientation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span>
                                          <span class="n">current_orientation</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                            <span class="n">m_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">global_i</span><span class="p">)</span>
                            <span class="n">m_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">global_j</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">save_update_info</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">m_e_locations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_length</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">face_index</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_neumann_boundary_values</span><span class="p">()]:</span>
            <span class="n">m_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span>
            <span class="n">m_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
            <span class="n">m_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_update_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m_data_for_update</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m_e_locations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m_e_locations</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;all ortho&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_ortho</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">m_data</span><span class="p">,</span> <span class="n">m_row</span><span class="p">,</span> <span class="n">m_col</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="MFD.build_m"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_m">[docs]</a>    <span class="k">def</span> <span class="nf">build_m</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_update_info</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">k_unity</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Construct the global matrix M_x. This is</span>
<span class="sd">        done by first constructing local matrices</span>
<span class="sd">        M_E and constructing a coo matrix for</span>
<span class="sd">        the global matrix. This function avoids adding</span>
<span class="sd">        the neumann boundaries to the matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_diagonality</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diagonality_index_list</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">())</span>

        <span class="n">m_data</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">m_row</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">m_col</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_update_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m_e_locations</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">current_length</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neumann_needs_updating</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renumber_for_neumann</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">()):</span>
            <span class="n">m_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_m_e</span><span class="p">(</span><span class="n">cell_index</span><span class="p">,</span> <span class="n">k_unity</span><span class="p">)</span>
            <span class="n">m_e_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">m_e</span><span class="p">)</span>
            <span class="n">neumann_faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cell_faces_neumann</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>

            <span class="n">current_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
            <span class="n">current_orientation</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_normal_orientation</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m_e</span><span class="p">)):</span>
                <span class="n">global_i</span> <span class="o">=</span> <span class="n">current_cell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">global_i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">neumann_faces</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m_e</span><span class="p">)):</span>
                        <span class="n">global_j</span> <span class="o">=</span> <span class="n">current_cell</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">global_j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">neumann_faces</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m_e</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="n">m_e_norm</span> <span class="o">&gt;</span> <span class="mf">1.e-20</span><span class="p">:</span>
                                <span class="n">current_length</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">m_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m_e</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">*</span>
                                              <span class="n">current_orientation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span>
                                              <span class="n">current_orientation</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                                <span class="n">m_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">global_i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                                <span class="n">m_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">global_j</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">save_update_info</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">m_e_locations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_length</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_update_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m_data_for_update</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m_e_locations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m_e_locations</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;all ortho&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_ortho</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">m_data</span><span class="p">,</span> <span class="n">m_row</span><span class="p">,</span> <span class="n">m_col</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="MFD.proj_vector"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.proj_vector">[docs]</a>    <span class="k">def</span> <span class="nf">proj_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector_f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Projects vector onto face degrees of freedom</span>
<span class="sd">        that can be indexed locally from the cells.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vector_p</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">()):</span>
            <span class="n">vector_p</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="n">face_orient</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_index</span><span class="p">),</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_normal_orientation</span><span class="p">(</span><span class="n">cell_index</span><span class="p">))</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">face_index</span><span class="p">,</span> <span class="n">orient</span><span class="p">)</span> <span class="ow">in</span> <span class="n">face_orient</span><span class="p">:</span>
                <span class="n">current_centroid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_real_centroid</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
                <span class="n">current_normal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_normal</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span><span class="o">*</span><span class="n">orient</span>
                <span class="n">proj_value</span> <span class="o">=</span> <span class="n">vector_f</span><span class="p">(</span><span class="n">current_centroid</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">current_normal</span><span class="p">)</span>
                <span class="n">vector_p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proj_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vector_p</span>
</div>
<div class="viewcode-block" id="MFD.build_advection"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_advection">[docs]</a>    <span class="k">def</span> <span class="nf">build_advection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">k_unity</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Constructs the advection matrix based on building</span>
<span class="sd">        the local matrices m_e and a provided local advection</span>
<span class="sd">        vector beta.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">a_data</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">a_row</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">a_col</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neumann_needs_updating</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renumber_for_neumann</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">()):</span>
            <span class="n">current_beta</span> <span class="o">=</span> <span class="n">beta</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span>
            <span class="n">neumann_faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cell_faces_neumann</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>

            <span class="n">current_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
            <span class="n">current_orientation</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_normal_orientation</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
            <span class="n">current_beta</span> <span class="o">=</span> <span class="n">beta</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">current_beta</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">current_beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">current_orientation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="c">#                if current_beta[i]:</span>
                    <span class="n">global_i</span> <span class="o">=</span> <span class="n">current_cell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">global_i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">neumann_faces</span><span class="p">:</span>
                        <span class="n">a_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_beta</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">a_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_index</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_dof</span><span class="p">)</span>
                        <span class="n">a_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">global_i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">()):</span>
                <span class="n">m_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_m_e</span><span class="p">(</span><span class="n">cell_index</span><span class="p">,</span> <span class="n">k_unity</span><span class="p">)</span>

                <span class="n">m_e_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">m_e</span><span class="p">)</span>
                <span class="n">neumann_faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cell_faces_neumann</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>

                <span class="n">current_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
                <span class="n">current_orientation</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_normal_orientation</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>

                <span class="n">current_beta</span> <span class="o">=</span> <span class="n">beta</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span>

                <span class="n">m_e_beta</span> <span class="o">=</span> <span class="n">m_e</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">current_beta</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m_e_beta</span><span class="p">)):</span>
                    <span class="n">global_i</span> <span class="o">=</span> <span class="n">current_cell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">global_i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">neumann_faces</span><span class="p">:</span>
                        <span class="n">a_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m_e_beta</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">a_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_index</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_dof</span><span class="p">)</span>
                        <span class="n">a_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">global_i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">a_data</span><span class="p">,</span> <span class="n">a_row</span><span class="p">,</span> <span class="n">a_col</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="MFD.build_m_parallel"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_m_parallel">[docs]</a>    <span class="k">def</span> <span class="nf">build_m_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_update_info</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">k_unity</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Construct the global matrix M_x. This is</span>
<span class="sd">        done by first constructing local matrices</span>
<span class="sd">        M_E and constructing a coo matrix for</span>
<span class="sd">        the global matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_diagonality</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diagonality_index_list</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">())</span>

        <span class="n">m_data</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;f&#39;</span><span class="p">)</span>
        <span class="n">m_row</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">m_col</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_update_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m_e_locations</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">current_length</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">neumann_boundary_indices</span> <span class="o">=</span> \
            <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_neumann_boundary_values</span><span class="p">()]</span>

        <span class="k">for</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">()):</span>
            <span class="n">m_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_m_e</span><span class="p">(</span><span class="n">cell_index</span><span class="p">,</span> <span class="n">k_unity</span><span class="p">)</span>

            <span class="n">current_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
            <span class="n">current_orientation</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_normal_orientation</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m_e</span><span class="p">)):</span>
                <span class="n">global_i</span> <span class="o">=</span> <span class="n">current_cell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">global_i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">neumann_boundary_indices</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m_e</span><span class="p">)):</span>
                        <span class="n">global_j</span> <span class="o">=</span> <span class="n">current_cell</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m_e</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1.e-40</span><span class="p">:</span>
                            <span class="n">current_length</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">m_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m_e</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">*</span>
                                          <span class="n">current_orientation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span>
                                          <span class="n">current_orientation</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                            <span class="n">m_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">global_i</span><span class="p">)</span>
                            <span class="n">m_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">global_j</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">save_update_info</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">m_e_locations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_length</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">face_index</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_neumann_boundary_values</span><span class="p">()]:</span>
            <span class="n">m_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span>
            <span class="n">m_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
            <span class="n">m_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;All Ortho = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_ortho</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_update_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m_data_for_update</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">m_data</span><span class="p">,</span> <span class="n">m_row</span><span class="p">,</span> <span class="n">m_col</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="MFD.update_m"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.update_m">[docs]</a>    <span class="k">def</span> <span class="nf">update_m</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m_coo</span><span class="p">,</span> <span class="n">multipliers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Updates matrix Mx using a list of constants</span>
<span class="sd">        that represent values multiplied by K.</span>
<span class="sd">        For this function to work, the</span>
<span class="sd">        save_update_info would have to be set</span>
<span class="sd">        to True while running build_m function.</span>
<span class="sd">        The MFD instance saves the original m_e</span>
<span class="sd">        matrices used to construct the full Mx</span>
<span class="sd">        matrix in coo format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mfd_cython</span><span class="o">.</span><span class="n">update_m_fast</span><span class="p">(</span><span class="n">m_coo</span><span class="p">,</span>
                                 <span class="n">multipliers</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">m_data_for_update</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">m_e_locations</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="MFD.build_bottom_right"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_bottom_right">[docs]</a>    <span class="k">def</span> <span class="nf">build_bottom_right</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Build the matrix C in the global</span>
<span class="sd">        saddle point problem (bottom right</span>
<span class="sd">        side of the matrix). Returns</span>
<span class="sd">        data, row and col data for coo matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bottom_right_data</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">bottom_right_row</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">bottom_right_col</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">is_using_alpha_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">()):</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_alpha_by_cell</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span><span class="o">*</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_volume</span><span class="p">(</span><span class="n">cell_index</span><span class="p">))</span>
                <span class="n">bottom_right_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
                <span class="n">bottom_right_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_index</span> <span class="o">+</span>
                                        <span class="n">shift</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_dof</span><span class="p">)</span>
                <span class="n">bottom_right_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_index</span> <span class="o">+</span>
                                        <span class="n">shift</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_dof</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">()):</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_volume</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
                <span class="n">bottom_right_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
                <span class="n">bottom_right_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_index</span> <span class="o">+</span>
                                        <span class="n">shift</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_dof</span><span class="p">)</span>
                <span class="n">bottom_right_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_index</span> <span class="o">+</span>
                                        <span class="n">shift</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_dof</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">bottom_right_data</span><span class="p">,</span> <span class="n">bottom_right_row</span><span class="p">,</span> <span class="n">bottom_right_col</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="MFD.build_coupling_terms"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_coupling_terms">[docs]</a>    <span class="k">def</span> <span class="nf">build_coupling_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Builds matrices L and L^T that</span>
<span class="sd">        couple the fracture domains</span>
<span class="sd">        with the reservoir as well as</span>
<span class="sd">        different reservoir domains.</span>
<span class="sd">        Used information found in the</span>
<span class="sd">        boundary and forcing function</span>
<span class="sd">        pointers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coupling_data</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">coupling_row</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">coupling_col</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_forcing_pointer_cells</span><span class="p">():</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">face_index</span><span class="p">,</span> <span class="n">orientation</span><span class="p">)</span> <span class="ow">in</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_forcing_pointers_for_cell</span><span class="p">(</span><span class="n">cell_index</span><span class="p">):</span>
                <span class="n">coupling_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_area</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span> <span class="o">*</span>
                                      <span class="n">orientation</span><span class="p">)</span>
                <span class="n">coupling_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_index</span> <span class="o">+</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">flux_dof</span><span class="p">)</span>
                <span class="n">coupling_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">face_index</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">face_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_dirichlet_pointer_faces</span><span class="p">():</span>
            <span class="p">(</span><span class="n">cell_index</span><span class="p">,</span> <span class="n">orientation</span><span class="p">)</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_dirichlet_pointer</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
            <span class="n">coupling_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_area</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span> <span class="o">*</span>
                                 <span class="n">orientation</span><span class="p">)</span>
            <span class="n">coupling_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">face_index</span><span class="p">])</span>
            <span class="n">coupling_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_index</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_dof</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">face_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_all_face_to_lagrange_pointers</span><span class="p">():</span>
            <span class="p">(</span><span class="n">lagrange_index</span><span class="p">,</span> <span class="n">orientation</span><span class="p">)</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_to_lagrange_pointer</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
            <span class="n">coupling_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_area</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span> <span class="o">*</span>
                                 <span class="n">orientation</span><span class="p">)</span>
            <span class="n">coupling_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">face_index</span><span class="p">])</span>
            <span class="n">coupling_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">lagrange_index</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">lagrange_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_all_lagrange_to_face_pointers</span><span class="p">():</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">face_index</span><span class="p">,</span> <span class="n">orientation</span><span class="p">)</span> <span class="ow">in</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_lagrange_to_face_pointers</span><span class="p">(</span><span class="n">lagrange_index</span><span class="p">):</span>
                <span class="n">coupling_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_area</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span> <span class="o">*</span>
                                      <span class="n">orientation</span><span class="p">)</span>
                <span class="n">coupling_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">lagrange_index</span><span class="p">])</span>
                <span class="n">coupling_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">face_index</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">periodic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">periodic_boundaries</span><span class="p">:</span>
            <span class="n">face_index_1</span> <span class="o">=</span> <span class="n">periodic</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">face_orientation_1</span> <span class="o">=</span> <span class="n">periodic</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">face_index_2</span> <span class="o">=</span> <span class="n">periodic</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">face_orientation_2</span> <span class="o">=</span> <span class="n">periodic</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">lagrange_index_1</span> <span class="o">=</span> <span class="n">periodic</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

            <span class="c">## L^T</span>
            <span class="n">coupling_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_area</span><span class="p">(</span><span class="n">face_index_1</span><span class="p">)</span><span class="o">*</span>
                                 <span class="n">face_orientation_1</span><span class="p">)</span>
            <span class="n">coupling_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">face_index_1</span><span class="p">])</span>
            <span class="n">coupling_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">lagrange_index_1</span><span class="p">])</span>

            <span class="n">coupling_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_area</span><span class="p">(</span><span class="n">face_index_2</span><span class="p">)</span><span class="o">*</span>
                                  <span class="n">face_orientation_2</span><span class="p">)</span>
            <span class="n">coupling_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">face_index_2</span><span class="p">])</span>
            <span class="n">coupling_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">lagrange_index_1</span><span class="p">])</span>

            <span class="c"># L</span>
            <span class="n">coupling_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_orientation_1</span><span class="p">)</span>
            <span class="n">coupling_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">lagrange_index_1</span><span class="p">])</span>
            <span class="n">coupling_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">face_index_1</span><span class="p">])</span>

            <span class="n">coupling_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_orientation_2</span><span class="p">)</span>
            <span class="n">coupling_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">lagrange_index_1</span><span class="p">])</span>
            <span class="n">coupling_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">face_index_2</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">coupling_data</span><span class="p">,</span> <span class="n">coupling_row</span><span class="p">,</span> <span class="n">coupling_col</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="MFD.build_lhs"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_lhs">[docs]</a>    <span class="k">def</span> <span class="nf">build_lhs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Builds the entire saddle point problem,</span>
<span class="sd">        |  M    DIV^T |</span>
<span class="sd">        |             |</span>
<span class="sd">        | DIV     C   |</span>
<span class="sd">        Returns the system in coo matrix format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lhs_data</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">lhs_row</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">lhs_col</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>

        <span class="n">m_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_m</span><span class="p">()</span>

        <span class="n">lhs_data</span> <span class="o">+=</span> <span class="n">m_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lhs_row</span> <span class="o">+=</span> <span class="n">m_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lhs_col</span> <span class="o">+=</span> <span class="n">m_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">del</span> <span class="n">m_info</span>

        <span class="p">[</span><span class="n">div_info</span><span class="p">,</span> <span class="n">div_t_info</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_div</span><span class="p">()</span>

        <span class="n">lhs_data</span> <span class="o">+=</span> <span class="n">div_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lhs_row</span> <span class="o">+=</span> <span class="n">div_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lhs_col</span> <span class="o">+=</span> <span class="n">div_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">del</span> <span class="n">div_info</span>

        <span class="n">lhs_data</span> <span class="o">+=</span> <span class="n">div_t_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lhs_row</span> <span class="o">+=</span> <span class="n">div_t_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lhs_col</span> <span class="o">+=</span> <span class="n">div_t_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">del</span> <span class="n">div_t_info</span>

        <span class="n">c_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bottom_right</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>

        <span class="n">lhs_data</span> <span class="o">+=</span> <span class="n">c_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lhs_row</span> <span class="o">+=</span> <span class="n">c_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lhs_col</span> <span class="o">+=</span> <span class="n">c_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">del</span> <span class="n">c_info</span>

        <span class="n">coupling_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_coupling_terms</span><span class="p">()</span>

        <span class="n">lhs_data</span> <span class="o">+=</span> <span class="n">coupling_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lhs_row</span> <span class="o">+=</span> <span class="n">coupling_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lhs_col</span> <span class="o">+=</span> <span class="n">coupling_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">del</span> <span class="n">coupling_info</span>

        <span class="k">if</span> <span class="n">beta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">beta_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_advection</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
            <span class="n">lhs_data</span> <span class="o">+=</span> <span class="n">beta_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lhs_row</span> <span class="o">+=</span> <span class="n">beta_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lhs_col</span> <span class="o">+=</span> <span class="n">beta_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">lhs_data</span><span class="p">,</span>
                                      <span class="p">(</span><span class="n">lhs_row</span><span class="p">,</span>
                                       <span class="n">lhs_col</span><span class="p">)))</span>

        <span class="k">del</span> <span class="n">lhs_data</span>
        <span class="k">del</span> <span class="n">lhs_row</span>
        <span class="k">del</span> <span class="n">lhs_col</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span>
</div>
<div class="viewcode-block" id="MFD.build_lhs_petsc"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_lhs_petsc">[docs]</a>    <span class="k">def</span> <span class="nf">build_lhs_petsc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds the entire saddle point problem,</span>
<span class="sd">        |  M    DIV^T |</span>
<span class="sd">        |             |</span>
<span class="sd">        | DIV     C   |</span>
<span class="sd">        Returns the system in coo matrix format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_lhs</span><span class="p">()</span>
        <span class="n">lhs_csr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Mat</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">createAIJWithArrays</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">lhs_csr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">csr</span><span class="o">=</span><span class="p">(</span><span class="n">lhs_csr</span><span class="o">.</span><span class="n">indptr</span><span class="p">,</span>
                                                               <span class="n">lhs_csr</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span>
                                                               <span class="n">lhs_csr</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">assemblyBegin</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">assemblyEnd</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span>
</div>
<div class="viewcode-block" id="MFD.build_lhs_divided"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_lhs_divided">[docs]</a>    <span class="k">def</span> <span class="nf">build_lhs_divided</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Builds the saddle point problem,</span>
<span class="sd">        |  M    DIV^T |</span>
<span class="sd">        |             |</span>
<span class="sd">        | DIV     C   |</span>
<span class="sd">        divided into the separate components.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">m_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_m</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">m_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">m_info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">m_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>

        <span class="k">del</span> <span class="n">m_info</span>

        <span class="p">[</span><span class="n">div_info</span><span class="p">,</span> <span class="n">div_t_info</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_div</span><span class="p">(</span><span class="n">shift</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">div</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">div_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                      <span class="p">(</span><span class="n">div_info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                       <span class="n">div_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">div_t</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">div_t_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                        <span class="p">(</span><span class="n">div_t_info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                         <span class="n">div_t_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>

        <span class="k">del</span> <span class="n">div_info</span>
        <span class="k">del</span> <span class="n">div_t_info</span>

        <span class="n">c_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_bottom_right</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">c_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="p">(</span><span class="n">c_info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>

        <span class="k">del</span> <span class="n">c_info</span>

        <span class="n">coupling_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_coupling_terms</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">coupling_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coupling</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">coupling_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                               <span class="p">(</span><span class="n">coupling_info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                <span class="n">coupling_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">del</span> <span class="n">coupling_info</span>
</div>
<div class="viewcode-block" id="MFD.get_number_of_dof"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.get_number_of_dof">[docs]</a>    <span class="k">def</span> <span class="nf">get_number_of_dof</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns total number of degrees</span>
<span class="sd">        of freedom for the saddle-point system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">()</span><span class="o">+</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flux_dof</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MFD.build_rhs"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_rhs">[docs]</a>    <span class="k">def</span> <span class="nf">build_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Build RHS for the saddle-point problem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_number_of_dof</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">build_rhs_neumann</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_rhs_dirichlet</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_rhs_forcing</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span>
</div>
<div class="viewcode-block" id="MFD.add_gravity"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.add_gravity">[docs]</a>    <span class="k">def</span> <span class="nf">add_gravity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds gravity effects to right hand side of problem</span>
<span class="sd">        based on density, acceleration and gravity vector</span>
<span class="sd">        set in Mesh class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gravity_force</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_faces</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">face_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_faces</span><span class="p">()):</span>
            <span class="n">gravity_force</span><span class="p">[</span><span class="n">face_index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_fluid_density</span><span class="p">()</span>
            <span class="n">gravity_force</span><span class="p">[</span><span class="n">face_index</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_gravity_acceleration</span><span class="p">()</span>
            <span class="n">gravity_force</span><span class="p">[</span><span class="n">face_index</span><span class="p">]</span> <span class="o">*=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_gravity_vector</span><span class="p">(),</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_normal</span><span class="p">(</span><span class="n">face_index</span><span class="p">))</span>

        <span class="p">[</span><span class="n">m_data</span><span class="p">,</span> <span class="n">m_row</span><span class="p">,</span> <span class="n">m_col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_m</span><span class="p">(</span><span class="n">k_unity</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">m_coo</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m_data</span><span class="p">),</span>
                                   <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m_row</span><span class="p">),</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m_col</span><span class="p">))))</span>

        <span class="n">gravity_force</span> <span class="o">=</span> <span class="n">m_coo</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">gravity_force</span><span class="p">)</span>
        <span class="n">neumann_boundary_indices</span> <span class="o">=</span> \
            <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_neumann_boundary_values</span><span class="p">()]</span>

        <span class="k">for</span> <span class="n">face_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_faces</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">face_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">neumann_boundary_indices</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">[</span><span class="n">face_index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">gravity_force</span><span class="p">[</span><span class="n">face_index</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="MFD.build_rhs_forcing"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_rhs_forcing">[docs]</a>    <span class="k">def</span> <span class="nf">build_rhs_forcing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Construct the entries for the forcing</span>
<span class="sd">        function in the RHS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">[</span><span class="n">cell_index</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux_dof</span><span class="p">]</span> <span class="o">+=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">cell_forcing_function</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="MFD.build_rhs_neumann"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_rhs_neumann">[docs]</a>    <span class="k">def</span> <span class="nf">build_rhs_neumann</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Construct the entries for the Neumann boundaries</span>
<span class="sd">        in the RHS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="p">[</span><span class="n">boundary_index</span><span class="p">,</span> <span class="n">boundary_value</span><span class="p">]</span> <span class="ow">in</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">get_neumann_boundary_values</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">boundary_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">=</span>  <span class="n">boundary_value</span>
</div>
<div class="viewcode-block" id="MFD.get_cell_faces_neumann"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.get_cell_faces_neumann">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell_faces_neumann</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns all the faces in cell_index that</span>
<span class="sd">        are also neumann faces.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_faces_neumann</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_faces_neumann</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
</div>
<div class="viewcode-block" id="MFD.is_neumann_face"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.is_neumann_face">[docs]</a>    <span class="k">def</span> <span class="nf">is_neumann_face</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">face_index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns True if face is a Neumann</span>
<span class="sd">        boundary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">face_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neumann_boundary_values</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="MFD.apply_neumann_from_function"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.apply_neumann_from_function">[docs]</a>    <span class="k">def</span> <span class="nf">apply_neumann_from_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boundary_marker</span><span class="p">,</span> <span class="n">grad_u</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets the Neumann boundary values for the</span>
<span class="sd">        faces assigned to boundary_marker based on a</span>
<span class="sd">        a functional representation grad_u. All</span>
<span class="sd">        boundary faces associated with</span>
<span class="sd">        boundary_marker will be set as Neumann</span>
<span class="sd">        The function grad_u takes a Numpy array</span>
<span class="sd">        representing a point coordinate on the</span>
<span class="sd">        face and returns</span>
<span class="sd">        the vector of the Neumann condition at that point.</span>
<span class="sd">        The face centroid is used as a quadrature point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="p">[</span><span class="n">boundary_index</span><span class="p">,</span> <span class="n">boundary_orientation</span><span class="p">]</span> <span class="ow">in</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_boundary_faces_by_marker</span><span class="p">(</span><span class="n">boundary_marker</span><span class="p">):</span>
            <span class="n">current_normal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_normal</span><span class="p">(</span><span class="n">boundary_index</span><span class="p">)</span>
            <span class="n">current_centroid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_real_centroid</span><span class="p">(</span><span class="n">boundary_index</span><span class="p">)</span>
            <span class="n">current_grad</span> <span class="o">=</span> <span class="n">grad_u</span><span class="p">(</span><span class="n">current_centroid</span><span class="p">)</span>
            <span class="n">neumann_value</span> <span class="o">=</span> <span class="n">current_grad</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">current_normal</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">neumann_boundary_values</span><span class="p">[</span><span class="n">boundary_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">neumann_value</span>
            <span class="n">cell_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">face_to_cell</span><span class="p">[</span><span class="n">boundary_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">cell_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_index</span><span class="p">))</span>
            <span class="n">local_face_index</span> <span class="o">=</span> <span class="n">cell_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">boundary_index</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_faces_neumann</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cell_faces_neumann</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boundary_index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cell_faces_neumann</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">boundary_index</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">neumann_needs_updating</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="MFD.set_neumann_by_face"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.set_neumann_by_face">[docs]</a>    <span class="k">def</span> <span class="nf">set_neumann_by_face</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">face_index</span><span class="p">,</span>
                            <span class="n">face_orientation</span><span class="p">,</span>
                            <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Directly sets Neumann value to face_index.</span>
<span class="sd">        The input *value* corresponding to the</span>
<span class="sd">        integral of the pressure over the face.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neumann_boundary_values</span><span class="p">[</span><span class="n">face_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">cell_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">face_to_cell</span><span class="p">[</span><span class="n">face_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_faces_neumann</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell_faces_neumann</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell_faces_neumann</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">face_index</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">neumann_needs_updating</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="MFD.get_dirichlet_boundary_values"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.get_dirichlet_boundary_values">[docs]</a>    <span class="k">def</span> <span class="nf">get_dirichlet_boundary_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a list of all faces designated as</span>
<span class="sd">        Dirichlet boundaries and their values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirichlet_boundary_values</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MFD.get_dirichlet_value"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.get_dirichlet_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_dirichlet_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">face_index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return pressure value at face_index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirichlet_boundary_values</span><span class="p">[</span><span class="n">face_index</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="MFD.get_number_of_dirichlet_faces"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.get_number_of_dirichlet_faces">[docs]</a>    <span class="k">def</span> <span class="nf">get_number_of_dirichlet_faces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the number of Dirichlet boundary faces.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirichlet_boundary_values</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MFD.get_neumann_boundary_values"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.get_neumann_boundary_values">[docs]</a>    <span class="k">def</span> <span class="nf">get_neumann_boundary_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a list of all faces designated as</span>
<span class="sd">        Neumann boundaries and their values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neumann_boundary_values</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MFD.reset_dirichlet_boundaries"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.reset_dirichlet_boundaries">[docs]</a>    <span class="k">def</span> <span class="nf">reset_dirichlet_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Resets all Dirichlet bounday data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirichlet_boundary_values</span> <span class="o">=</span> <span class="p">{}</span>
</div>
<div class="viewcode-block" id="MFD.reset_neumann_boundaries"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.reset_neumann_boundaries">[docs]</a>    <span class="k">def</span> <span class="nf">reset_neumann_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Resets all Neumann bounday data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neumann_boundary_values</span> <span class="o">=</span> <span class="p">{}</span>
</div>
<div class="viewcode-block" id="MFD.apply_dirichlet_from_function"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.apply_dirichlet_from_function">[docs]</a>    <span class="k">def</span> <span class="nf">apply_dirichlet_from_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boundary_marker</span><span class="p">,</span> <span class="n">p_function</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets the Dirichlet boundary values for the</span>
<span class="sd">        for the faces assigned to boundary_marker based on</span>
<span class="sd">        a functional representation p_function. All</span>
<span class="sd">        boundary faces associated with</span>
<span class="sd">        boundary_marker will be set as Dirichlet.</span>
<span class="sd">        The p_function takes a Numpy array</span>
<span class="sd">        representing a point coordinate on the</span>
<span class="sd">        face and returns the scalar value of</span>
<span class="sd">        the Dirichlet condition at that point.</span>
<span class="sd">        The face centoid is used as a quadrature point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">boundary_index</span><span class="p">,</span> <span class="n">boundary_orientation</span><span class="p">)</span> \
                <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_boundary_faces_by_marker</span><span class="p">(</span><span class="n">boundary_marker</span><span class="p">):</span>
            <span class="n">current_centroid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_real_centroid</span><span class="p">(</span><span class="n">boundary_index</span><span class="p">)</span>
            <span class="n">dirichlet_value</span> <span class="o">=</span> <span class="n">p_function</span><span class="p">(</span><span class="n">current_centroid</span><span class="p">)</span>
            <span class="n">dirichlet_value</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_area</span><span class="p">(</span><span class="n">boundary_index</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dirichlet_boundary_values</span><span class="p">[</span><span class="n">boundary_index</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">dirichlet_value</span><span class="o">*</span><span class="n">boundary_orientation</span>
</div>
<div class="viewcode-block" id="MFD.apply_forcing_from_function"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.apply_forcing_from_function">[docs]</a>    <span class="k">def</span> <span class="nf">apply_forcing_from_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcing_function</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets forcing function for entire problem based on</span>
<span class="sd">        a functional representation forcing_function.</span>
<span class="sd">        The forcing_function takes a Numpy array</span>
<span class="sd">        representing a point coordinate and returns</span>
<span class="sd">        the value of the forcing function at that point.</span>
<span class="sd">        The cell centroid is used as a quadrature point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">()):</span>
            <span class="n">current_centroid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_real_centroid</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
            <span class="n">forcing_value</span> <span class="o">=</span> <span class="n">forcing_function</span><span class="p">(</span><span class="n">current_centroid</span><span class="p">)</span>
            <span class="n">forcing_value</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_volume</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell_forcing_function</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">forcing_value</span>
</div>
<div class="viewcode-block" id="MFD.apply_forcing_from_grad"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.apply_forcing_from_grad">[docs]</a>    <span class="k">def</span> <span class="nf">apply_forcing_from_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad_p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Computes the source term for a cell from the</span>
<span class="sd">        exact representation of the gradient integrated over the</span>
<span class="sd">        boundaries of the cell.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">()):</span>
            <span class="n">face_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
            <span class="n">orientation_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_normal_orientation</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">face_index</span><span class="p">,</span> <span class="n">orientation</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">face_list</span><span class="p">,</span> <span class="n">orientation_list</span><span class="p">):</span>
                <span class="n">current_normal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_normal</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
                <span class="n">current_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_real_centroid</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
                <span class="n">exact_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">grad_p</span><span class="p">(</span><span class="n">current_center</span><span class="p">),</span> <span class="n">current_normal</span><span class="p">)</span>
                <span class="n">exact_flux</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_face_area</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
                <span class="n">exact_flux</span> <span class="o">*=</span> <span class="n">orientation</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cell_forcing_function</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">exact_flux</span>
</div>
<div class="viewcode-block" id="MFD.process_internal_boundaries"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.process_internal_boundaries">[docs]</a>    <span class="k">def</span> <span class="nf">process_internal_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Conducts appropriate processing needed</span>
<span class="sd">        to correctly incorporate internal boundary conditions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">face_index</span><span class="p">,</span> <span class="n">face_orientation</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_internal_no_flow</span><span class="p">():</span>
            <span class="n">cell_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">face_to_cell</span><span class="p">[</span><span class="n">face_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cell_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_index</span><span class="p">))</span>
            <span class="n">local_face_index</span> <span class="o">=</span> <span class="n">cell_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_faces_neumann</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cell_faces_neumann</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cell_faces_neumann</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">face_index</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">neumann_boundary_values</span><span class="p">[</span><span class="n">face_index</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
</div>
<div class="viewcode-block" id="MFD.build_rhs_dirichlet"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.build_rhs_dirichlet">[docs]</a>    <span class="k">def</span> <span class="nf">build_rhs_dirichlet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Construct the entries for the Dirichlet boundaries</span>
<span class="sd">        in the RHS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="p">[</span><span class="n">boundary_index</span><span class="p">,</span> <span class="n">boundary_value</span><span class="p">]</span> <span class="ow">in</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">get_dirichlet_boundary_values</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">boundary_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="n">boundary_value</span>
</div>
<div class="viewcode-block" id="MFD.get_analytical_pressure_solution"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.get_analytical_pressure_solution">[docs]</a>    <span class="k">def</span> <span class="nf">get_analytical_pressure_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                         <span class="n">p_function</span><span class="p">,</span>
                                         <span class="n">quadrature_method</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the average pressure over each cell computed</span>
<span class="sd">        by using the real centroid of the cell as quadrature.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">quadrature_method</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">p_array</span> <span class="o">=</span> <span class="p">[</span><span class="n">p_function</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="k">for</span>
                       <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_all_cell_real_centroids</span><span class="p">()]</span>
        <span class="k">elif</span> <span class="n">quadrature_method</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">p_array</span> <span class="o">=</span> <span class="p">[</span><span class="n">p_function</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="k">for</span>
                       <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_all_cell_shifted_centroids</span><span class="p">()]</span>

        <span class="k">return</span> <span class="n">p_array</span>
</div>
<div class="viewcode-block" id="MFD.get_analytical_velocity_solution"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.get_analytical_velocity_solution">[docs]</a>    <span class="k">def</span> <span class="nf">get_analytical_velocity_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad_p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the average flux over each face computed</span>
<span class="sd">        by using the real centroid of the face as quadrature.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flux_vector</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">face_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_faces</span><span class="p">()):</span>
            <span class="n">current_normal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_normal</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
            <span class="n">current_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_real_centroid</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>

            <span class="n">flux_vector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">grad_p</span><span class="p">(</span><span class="n">current_center</span><span class="p">),</span> <span class="n">current_normal</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">flux_vector</span>
</div>
<div class="viewcode-block" id="MFD.l2_error_velocity_per_cell"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.l2_error_velocity_per_cell">[docs]</a>    <span class="k">def</span> <span class="nf">l2_error_velocity_per_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad_p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a vector of length number of cells</span>
<span class="sd">        with the relative error of the velocity</span>
<span class="sd">        for each cell.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">()):</span>
            <span class="n">error_flux_numerator</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">error_flux_denominator</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">for</span> <span class="n">face_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_index</span><span class="p">):</span>
                <span class="n">current_normal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_normal</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
                <span class="n">current_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_real_centroid</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>

                <span class="n">exact_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">grad_p</span><span class="p">(</span><span class="n">current_center</span><span class="p">),</span> <span class="n">current_normal</span><span class="p">)</span>

                <span class="n">error_flux_numerator</span> <span class="o">+=</span> \
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_volume</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span><span class="o">*</span>
                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">[</span><span class="n">face_index</span><span class="p">]</span><span class="o">-</span><span class="n">exact_flux</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="n">error_flux_denominator</span> <span class="o">+=</span> \
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_volume</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">exact_flux</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">error_flux</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_flux_numerator</span><span class="o">/</span><span class="n">error_flux_denominator</span>
            <span class="n">error_flux</span><span class="p">[</span><span class="n">cell_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_flux</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">error_flux</span>
</div>
<div class="viewcode-block" id="MFD.compute_l2_error_velocity"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.compute_l2_error_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">compute_l2_error_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad_p</span><span class="p">,</span> <span class="n">quadrature_method</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Computes the L2 velocity error of the final</span>
<span class="sd">        solution relative to an analytical solution</span>
<span class="sd">        grad_p.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error_flux_numerator</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="k">for</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">face_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_index</span><span class="p">):</span>
                <span class="n">current_normal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_normal</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">quadrature_method</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">current_center</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_real_centroid</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">quadrature_method</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">current_center</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_shifted_centroid</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;no quadrature for method&quot;</span> <span class="o">+</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">quadrature_method</span><span class="p">))</span>

                <span class="n">exact_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">grad_p</span><span class="p">(</span><span class="n">current_center</span><span class="p">),</span> <span class="n">current_normal</span><span class="p">)</span>

                <span class="n">error_flux_numerator</span> <span class="o">+=</span> \
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_volume</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span><span class="o">*</span>
                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">[</span><span class="n">face_index</span><span class="p">]</span><span class="o">-</span><span class="n">exact_flux</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_flux_numerator</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MFD.compute_x_error_velocity"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.compute_x_error_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">compute_x_error_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad_p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute the velocity error in the X norm</span>
<span class="sd">        ||| grad_p^I - v_h |||_X</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grad_p_i_min_v_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_faces</span><span class="p">()</span> <span class="o">+</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">face_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_faces</span><span class="p">()):</span>
            <span class="n">current_centroid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_real_centroid</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
            <span class="n">current_normal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_face_normal</span><span class="p">(</span><span class="n">face_index</span><span class="p">)</span>
            <span class="n">grad_p_i_min_v_h</span><span class="p">[</span><span class="n">face_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">grad_p</span><span class="p">(</span><span class="n">current_centroid</span><span class="p">),</span>
                                                  <span class="n">current_normal</span><span class="p">)</span>

            <span class="n">grad_p_i_min_v_h</span><span class="p">[</span><span class="n">face_index</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">[</span><span class="n">face_index</span><span class="p">]</span>

        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">grad_p_i_min_v_h</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_faces</span><span class="p">()]</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">grad_p_i_min_v_h</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_faces</span><span class="p">()])</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MFD.compute_l2_error_pressure"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.compute_l2_error_pressure">[docs]</a>    <span class="k">def</span> <span class="nf">compute_l2_error_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_function</span><span class="p">,</span> <span class="n">quadrature_method</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Computes the L2 error against a analytical solution p_function.</span>
<span class="sd">        The option quadrature_method specifies the way integral is</span>
<span class="sd">        approximated:</span>
<span class="sd">        0 =&gt; use the real cell centroid.</span>
<span class="sd">        1 =&gt; use the shifted cell centroid.</span>
<span class="sd">        2 =&gt; use quadrature points specified in mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error_numerator</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">error_denominator</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="k">for</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">quadrature_method</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">current_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_real_centroid</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
                <span class="n">exact_pressure</span> <span class="o">=</span> <span class="n">p_function</span><span class="p">(</span><span class="n">current_center</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">quadrature_method</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">current_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_shifted_centroid</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
                <span class="n">exact_pressure</span> <span class="o">=</span> <span class="n">p_function</span><span class="p">(</span><span class="n">current_center</span><span class="p">)</span>

            <span class="n">error_numerator</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_volume</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span><span class="o">*</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_faces</span><span class="p">()</span><span class="o">+</span><span class="n">cell_index</span><span class="p">]</span><span class="o">-</span> \
                     <span class="n">exact_pressure</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">error_denominator</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_cell_volume</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span><span class="o">*</span> \
                <span class="n">exact_pressure</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_numerator</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MFD.solve"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_guess</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">solver</span> <span class="o">=</span> <span class="s">&#39;spsolve&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Solves the full saddle points system after construction</span>
<span class="sd">        of the LHS and RHS of the problem. Returns the full</span>
<span class="sd">        solution vector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_faces</span><span class="p">()</span> <span class="o">+</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s">&#39;spsolve&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">tocsc</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">spsolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s">&#39;gmres&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">tocsc</span><span class="p">()</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">,</span> <span class="n">converged</span><span class="p">]</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">gmres</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span>
                                                      <span class="n">tol</span><span class="o">=</span><span class="mf">1.e-8</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">converged</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;did not converge after&quot;</span><span class="p">,</span> <span class="n">converged</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span>
</div>
<div class="viewcode-block" id="MFD.cg_inner"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.cg_inner">[docs]</a>    <span class="k">def</span> <span class="nf">cg_inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apply_lhs</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">tol</span> <span class="o">=</span> <span class="mf">1.e-8</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Local implementation of CG algorithm.</span>
<span class="sd">        Code from example in wikipedia page on CG methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">b</span><span class="o">-</span><span class="n">apply_lhs</span><span class="p">(</span><span class="n">current_x</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="n">rsold</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rsold</span><span class="o">&lt;</span><span class="n">tol</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">current_x</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s"> inner iter&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">Ap</span> <span class="o">=</span> <span class="n">apply_lhs</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">pAp</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ap</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pAp</span><span class="o">&lt;</span><span class="mf">1.e-42</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">current_x</span>

            <span class="n">alpha</span> <span class="o">=</span> <span class="n">rsold</span><span class="o">/</span><span class="n">p</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ap</span><span class="p">)</span>

            <span class="n">current_x</span> <span class="o">+=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">p</span>
            <span class="n">r</span><span class="o">-=</span><span class="n">alpha</span><span class="o">*</span><span class="n">Ap</span>
            <span class="n">rsnew</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rsnew</span><span class="o">&lt;</span><span class="n">tol</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">current_x</span>
            <span class="n">p</span><span class="o">=</span><span class="n">r</span><span class="o">+</span><span class="n">rsnew</span><span class="o">/</span><span class="n">rsold</span><span class="o">*</span><span class="n">p</span>
            <span class="n">rsold</span> <span class="o">=</span> <span class="n">rsnew</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s"> went over max iterations&quot;</span><span class="p">,</span> <span class="n">rsnew</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">current_x</span>
</div>
<div class="viewcode-block" id="MFD.solve_divided"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.solve_divided">[docs]</a>    <span class="k">def</span> <span class="nf">solve_divided</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Solve the divided system of equations using</span>
<span class="sd">        a Schur compliment method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_faces</span><span class="p">()]</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_faces</span><span class="p">():]</span>

        <span class="n">current_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">())</span>


        <span class="k">def</span> <span class="nf">apply_lhs</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">div</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cg_inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">div_t</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                                         <span class="n">tol</span><span class="o">=</span><span class="mf">1.e-16</span><span class="p">))</span>

        <span class="n">f1_tilde</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">cg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">f1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">cg_rhs</span> <span class="o">=</span> <span class="n">f2</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">div</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">f1_tilde</span><span class="p">)</span>

        <span class="n">current_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="p">(</span><span class="n">apply_lhs</span><span class="p">,</span> <span class="n">cg_rhs</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;solver residual=&gt;&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">apply_lhs</span><span class="p">(</span><span class="n">current_p</span><span class="p">)</span><span class="o">-</span><span class="n">cg_rhs</span><span class="p">))</span>

        <span class="n">current_v</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">cg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">div_t</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">current_p</span><span class="p">),</span>
                               <span class="n">tol</span><span class="o">=</span><span class="mf">1.e-10</span><span class="p">)</span><span class="o">+</span><span class="n">f1_tilde</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">current_v</span><span class="p">,</span> <span class="n">current_p</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="MFD.solve_petsc"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.solve_petsc">[docs]</a>    <span class="k">def</span> <span class="nf">solve_petsc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Solving using PETSc, this requires the</span>
<span class="sd">        use of build_lhs_petsc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ksp</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">KSP</span><span class="p">()</span>
        <span class="n">ksp</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">PETSc</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>

        <span class="n">ksp</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="s">&#39;gmres&#39;</span><span class="p">)</span>
        <span class="n">ksp</span><span class="o">.</span><span class="n">getPC</span><span class="p">()</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="s">&#39;ilu&#39;</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">getVecs</span><span class="p">()</span>

        <span class="n">x</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">setArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">)</span>

        <span class="n">ksp</span><span class="o">.</span><span class="n">setOperators</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">)</span>
        <span class="n">ksp</span><span class="o">.</span><span class="n">setFromOptions</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;solving...&quot;</span><span class="p">)</span>
        <span class="n">ksp</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">getArray</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="MFD.get_pressure_solution"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.get_pressure_solution">[docs]</a>    <span class="k">def</span> <span class="nf">get_pressure_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the pressure solution for the problem. The</span>
<span class="sd">        pressures are indexed in the same order as the</span>
<span class="sd">        corresponding cell indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_dof</span><span class="p">:]</span>
</div>
<div class="viewcode-block" id="MFD.get_velocity_solution_by_index"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.get_velocity_solution_by_index">[docs]</a>    <span class="k">def</span> <span class="nf">get_velocity_solution_by_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">face_index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the flux for face index by face_index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">face_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.</span>
</div>
<div class="viewcode-block" id="MFD.get_velocity_solution"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.get_velocity_solution">[docs]</a>    <span class="k">def</span> <span class="nf">get_velocity_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the velocity solution for the problem. The</span>
<span class="sd">        fluxes are indexed in the same order as the</span>
<span class="sd">        corresponding face indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">full_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_faces</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">face_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_faces</span><span class="p">()):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face_to_flux</span><span class="p">[</span><span class="n">face_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">full_flux</span><span class="p">[</span><span class="n">face_index</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_number_of_cells</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">full_flux</span>
</div>
<div class="viewcode-block" id="MFD.lhs_rank"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.lhs_rank">[docs]</a>    <span class="k">def</span> <span class="nf">lhs_rank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the rank of the saddle-point problem</span>
<span class="sd">        using the SVD.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">todense</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">lhs</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">1.e-9</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="MFD.print_lhs_to_file"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.print_lhs_to_file">[docs]</a>    <span class="k">def</span> <span class="nf">print_lhs_to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Output entire LHS to file (dense format).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&quot;.dat&quot;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>

        <span class="n">lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>

        <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="n">lhs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">matout</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">matout</span><span class="p">)</span>

        <span class="n">matout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="MFD.lhs_svd"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.lhs_svd">[docs]</a>    <span class="k">def</span> <span class="nf">lhs_svd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the singular values</span>
<span class="sd">        of the lhs matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">todense</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">lhs</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="MFD.print_lhs_to_ppm"><a class="viewcode-back" href="../../../mfdclass.html#mimpy.mfd.mfd.MFD.print_lhs_to_ppm">[docs]</a>    <span class="k">def</span> <span class="nf">print_lhs_to_ppm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Output LHS to ppm image file type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&quot;.ppm&quot;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>

        <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;P1&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">matout</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">matout</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1.e-10</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">matout</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">matout</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">matout</span><span class="p">)</span>

        <span class="n">matout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Omar Al-Hinai.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>